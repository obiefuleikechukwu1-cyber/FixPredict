<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixPredict Dashboard - IoT Maintenance Marketplace</title>
    <script src="https://unpkg.com/@stacks/connect@7.7.1/lib/index.js"></script>
    <script src="https://unpkg.com/@stacks/transactions@6.11.0/lib/index.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h1 span {
            color: #667eea;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        .card h3 {
            margin-top: 0;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a6fd8;
        }
        .equipment-list, .contract-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .equipment-card, .contract-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .equipment-card h4, .contract-card h4 {
            margin-top: 0;
            color: #333;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        .connect-wallet {
            text-align: center;
            margin-bottom: 30px;
        }
        .wallet-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status-active { color: #28a745; }
        .status-failed { color: #dc3545; }
        .status-completed { color: #17a2b8; }
        .status-pending { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß <span>FixPredict</span> Dashboard</h1>
        <p style="text-align: center; color: #666; margin-bottom: 40px;">IoT-Powered Predictive Maintenance Marketplace</p>

        <div id="wallet-section" class="connect-wallet">
            <button id="connect-wallet" onclick="connectWallet()">Connect Wallet</button>
            <div id="wallet-info" class="wallet-info" style="display: none;"></div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üìä Platform Overview</h3>
                <div class="stats">
                    <div class="stat">
                        <div>Total Equipment</div>
                        <div id="total-equipment" class="stat-value">-</div>
                    </div>
                    <div class="stat">
                        <div>Total Predictions</div>
                        <div id="total-predictions" class="stat-value">-</div>
                    </div>
                    <div class="stat">
                        <div>Insurance Pool</div>
                        <div id="insurance-pool" class="stat-value">-</div>
                    </div>
                    <div class="stat">
                        <div>Platform Treasury</div>
                        <div id="platform-treasury" class="stat-value">-</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div><strong>Contract Status:</strong> <span id="contract-status">-</span></div>
                    <div><strong>Emergency Mode:</strong> <span id="emergency-mode">-</span></div>
                </div>
            </div>

            <div class="card">
                <h3>üè≠ Register Equipment</h3>
                <form id="equipment-form">
                    <div class="form-group">
                        <label for="equipment-type">Equipment Type:</label>
                        <input type="text" id="equipment-type" placeholder="e.g., Industrial Pump, CNC Machine" required>
                    </div>
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <input type="text" id="location" placeholder="e.g., Factory Floor A, Building 3" required>
                    </div>
                    <div class="form-group">
                        <label for="sensor-id">IoT Sensor ID:</label>
                        <input type="text" id="sensor-id" placeholder="e.g., SENSOR-001-ABC123" required>
                    </div>
                    <button type="submit">Register Equipment</button>
                </form>
            </div>

            <div class="card">
                <h3>üë®‚Äçüîß Register Service Provider</h3>
                <form id="provider-form">
                    <div class="form-group">
                        <label for="company-name">Company Name:</label>
                        <input type="text" id="company-name" placeholder="e.g., ABC Maintenance Co." required>
                    </div>
                    <button type="submit">Register as Provider</button>
                </form>
                <div id="provider-info" style="margin-top: 15px;"></div>
            </div>

            <div class="card">
                <h3>üîÆ Submit Prediction</h3>
                <form id="prediction-form">
                    <div class="form-group">
                        <label for="pred-equipment-id">Equipment ID:</label>
                        <input type="number" id="pred-equipment-id" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="failure-block">Predicted Failure Block:</label>
                        <input type="number" id="failure-block" min="1" placeholder="Future block number" required>
                    </div>
                    <div class="form-group">
                        <label for="stake-amount">Stake Amount (FIX):</label>
                        <input type="number" id="stake-amount" step="0.000001" min="1000" placeholder="2000" required>
                    </div>
                    <div class="form-group">
                        <label for="contract-value">Contract Value (FIX):</label>
                        <input type="number" id="contract-value" step="0.000001" min="1000" placeholder="10000" required>
                    </div>
                    <button type="submit">Submit Prediction</button>
                </form>
            </div>

            <div class="card">
                <h3>‚úÖ Validate Prediction</h3>
                <form id="validation-form">
                    <div class="form-group">
                        <label for="validate-contract-id">Contract ID:</label>
                        <input type="number" id="validate-contract-id" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="maintenance-occurred">Maintenance Occurred:</label>
                        <select id="maintenance-occurred" required>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <button type="submit">Validate Prediction</button>
                </form>
            </div>

            <div class="card">
                <h3>üõ°Ô∏è Claim Insurance</h3>
                <form id="insurance-form">
                    <div class="form-group">
                        <label for="insurance-contract-id">Contract ID:</label>
                        <input type="number" id="insurance-contract-id" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="claim-amount">Claim Amount (FIX):</label>
                        <input type="number" id="claim-amount" step="0.000001" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="claim-reason">Claim Reason:</label>
                        <textarea id="claim-reason" rows="3" placeholder="Describe the equipment failure..." required></textarea>
                    </div>
                    <button type="submit">Submit Insurance Claim</button>
                </form>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üè≠ My Equipment</h3>
                <button onclick="loadMyEquipment()">Load My Equipment</button>
                <div id="my-equipment" class="equipment-list"></div>
            </div>

            <div class="card">
                <h3>üìã Active Contracts</h3>
                <button onclick="loadActiveContracts()">Load Active Contracts</button>
                <div id="active-contracts" class="contract-list"></div>
            </div>
        </div>
    </div>

    <script>
        let userSession = null;
        const contractAddress = 'ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM'; // Update with actual contract address
        const contractName = 'FixPredictcontract';

        // Initialize Stacks Connect
        const appConfig = new AppConfig(['store_write', 'publish_data']);
        userSession = new UserSession({ appConfig });

        async function connectWallet() {
            if (!userSession.isUserSignedIn()) {
                userSession.redirectToSignIn();
            } else {
                showWalletInfo();
                loadPlatformStats();
                loadProviderInfo();
            }
        }

        function showWalletInfo() {
            const walletInfo = document.getElementById('wallet-info');
            const userData = userSession.loadUserData();
            walletInfo.innerHTML = `
                <strong>Connected:</strong> ${userData.profile.stxAddress.testnet}<br>
                <strong>FIX Balance:</strong> Loading...
            `;
            walletInfo.style.display = 'block';
            document.getElementById('connect-wallet').style.display = 'none';

            // Load FIX token balance
            loadTokenBalance(userData.profile.stxAddress.testnet);
        }

        async function loadTokenBalance(address) {
            try {
                const balance = await callReadOnly('get-fix-token-balance', [`'${address}'`]);
                document.getElementById('wallet-info').innerHTML += `<br><strong>FIX Balance:</strong> ${balance} tokens`;
            } catch (error) {
                console.error('Error loading token balance:', error);
            }
        }

        async function loadPlatformStats() {
            try {
                const stats = await callReadOnly('get-platform-stats', []);

                document.getElementById('total-equipment').textContent = stats['total-equipment'];
                document.getElementById('total-predictions').textContent = stats['total-predictions'];
                document.getElementById('insurance-pool').textContent = stats['insurance-pool-size'];
                document.getElementById('platform-treasury').textContent = stats['platform-treasury'];

                const contractStatus = stats['contract-paused'] ? 'Paused' : 'Active';
                const emergencyStatus = stats['emergency-mode'] ? 'Active' : 'Inactive';

                document.getElementById('contract-status').textContent = contractStatus;
                document.getElementById('contract-status').className = stats['contract-paused'] ? 'status-failed' : 'status-active';

                document.getElementById('emergency-mode').textContent = emergencyStatus;
                document.getElementById('emergency-mode').className = stats['emergency-mode'] ? 'status-failed' : 'status-active';

            } catch (error) {
                console.error('Error loading platform stats:', error);
            }
        }

        async function loadProviderInfo() {
            try {
                const userData = userSession.loadUserData();
                const profile = await callReadOnly('get-provider-profile', [`'${userData.profile.stxAddress.testnet}'`]);

                if (profile) {
                    document.getElementById('provider-info').innerHTML = `
                        <strong>Registered Provider:</strong> ${profile['company-name']}<br>
                        <strong>Reputation Score:</strong> ${profile['reputation-score']}/100<br>
                        <strong>Total Contracts:</strong> ${profile['total-contracts']}<br>
                        <strong>Success Rate:</strong> ${profile['total-contracts'] > 0 ? Math.round((profile['successful-predictions'] / profile['total-contracts']) * 100) : 0}%
                    `;
                } else {
                    document.getElementById('provider-info').innerHTML = '<em>Not registered as a service provider</em>';
                }
            } catch (error) {
                console.error('Error loading provider info:', error);
            }
        }

        async function callReadOnly(functionName, args) {
            const network = new StacksTestnet();
            const callReadOnlyFn = await stacksConnect.callReadOnlyFn({
                network,
                contractAddress,
                contractName,
                functionName,
                functionArgs: args,
                senderAddress: userSession.loadUserData().profile.stxAddress.testnet,
            });
            return callReadOnlyFn.result;
        }

        async function callPublic(functionName, args) {
            const network = new StacksTestnet();
            const options = {
                network,
                contractAddress,
                contractName,
                functionName,
                functionArgs: args,
                appDetails: {
                    name: 'FixPredict Dashboard',
                    icon: window.location.origin + '/favicon.ico',
                },
                onFinish: (data) => {
                    console.log('Transaction finished:', data);
                    alert('Transaction submitted successfully!');
                    loadPlatformStats();
                    loadProviderInfo();
                },
                onCancel: () => {
                    alert('Transaction cancelled');
                },
            };
            await stacksConnect.openContractCall(options);
        }

        // Form handlers
        document.getElementById('equipment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const equipmentType = document.getElementById('equipment-type').value;
            const location = document.getElementById('location').value;
            const sensorId = document.getElementById('sensor-id').value;

            await callPublic('register-equipment', [
                stacksConnect.stringAsciiCV(equipmentType),
                stacksConnect.stringAsciiCV(location),
                stacksConnect.stringAsciiCV(sensorId)
            ]);
        });

        document.getElementById('provider-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyName = document.getElementById('company-name').value;

            await callPublic('register-service-provider', [
                stacksConnect.stringAsciiCV(companyName)
            ]);
        });

        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const equipmentId = parseInt(document.getElementById('pred-equipment-id').value);
            const failureBlock = parseInt(document.getElementById('failure-block').value);
            const stakeAmount = Math.floor(parseFloat(document.getElementById('stake-amount').value) * 1000000); // Convert to microFIX
            const contractValue = Math.floor(parseFloat(document.getElementById('contract-value').value) * 1000000);

            await callPublic('submit-maintenance-prediction', [
                stacksConnect.uintCV(equipmentId),
                stacksConnect.uintCV(failureBlock),
                stacksConnect.uintCV(stakeAmount),
                stacksConnect.uintCV(contractValue)
            ]);
        });

        document.getElementById('validation-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const contractId = parseInt(document.getElementById('validate-contract-id').value);
            const occurred = document.getElementById('maintenance-occurred').value === 'true';

            await callPublic('validate-prediction', [
                stacksConnect.uintCV(contractId),
                stacksConnect.booleanCV(occurred)
            ]);
        });

        document.getElementById('insurance-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const contractId = parseInt(document.getElementById('insurance-contract-id').value);
            const claimAmount = Math.floor(parseFloat(document.getElementById('claim-amount').value) * 1000000);
            const claimReason = document.getElementById('claim-reason').value;

            await callPublic('claim-insurance', [
                stacksConnect.uintCV(contractId),
                stacksConnect.uintCV(claimAmount),
                stacksConnect.stringAsciiCV(claimReason)
            ]);
        });

        async function loadMyEquipment() {
            try {
                const userData = userSession.loadUserData();
                const equipmentContainer = document.getElementById('my-equipment');
                equipmentContainer.innerHTML = '<p>Loading equipment...</p>';

                // Since we don't have a direct way to get all equipment by owner,
                // we'll need to check equipment IDs sequentially
                let equipmentFound = [];
                for (let i = 1; i <= 20; i++) { // Check first 20 equipment IDs
                    try {
                        const equipment = await callReadOnly('get-equipment-info', [stacksConnect.uintCV(i)]);
                        if (equipment && equipment.owner === userData.profile.stxAddress.testnet) {
                            equipmentFound.push({...equipment, id: i});
                        }
                    } catch (e) {
                        // Continue checking
                    }
                }

                equipmentContainer.innerHTML = '';
                equipmentFound.forEach(equipment => {
                    const equipmentCard = document.createElement('div');
                    equipmentCard.className = 'equipment-card';
                    equipmentCard.innerHTML = `
                        <h4>Equipment #${equipment.id}</h4>
                        <p><strong>Type:</strong> ${equipment['equipment-type']}</p>
                        <p><strong>Location:</strong> ${equipment.location}</p>
                        <p><strong>Sensor ID:</strong> ${equipment['iot-sensor-id']}</p>
                        <p><strong>Status:</strong> <span class="${equipment['is-active'] ? 'status-active' : 'status-failed'}">${equipment['is-active'] ? 'Active' : 'Inactive'}</span></p>
                        <p><strong>Last Maintenance:</strong> Block ${equipment['last-maintenance']}</p>
                    `;
                    equipmentContainer.appendChild(equipmentCard);
                });

                if (equipmentFound.length === 0) {
                    equipmentContainer.innerHTML = '<p>No equipment registered yet.</p>';
                }

            } catch (error) {
                console.error('Error loading equipment:', error);
                document.getElementById('my-equipment').innerHTML = '<p>Error loading equipment.</p>';
            }
        }

        async function loadActiveContracts() {
            try {
                const contractContainer = document.getElementById('active-contracts');
                contractContainer.innerHTML = '<p>Loading contracts...</p>';

                // Check recent contracts
                let contractsFound = [];
                for (let i = 1; i <= 20; i++) { // Check first 20 contract IDs
                    try {
                        const contract = await callReadOnly('get-contract-info', [stacksConnect.uintCV(i)]);
                        if (contract && contract.status === "active") {
                            contractsFound.push({...contract, id: i});
                        }
                    } catch (e) {
                        // Continue checking
                    }
                }

                contractContainer.innerHTML = '';
                contractsFound.slice(0, 6).forEach(contract => { // Show first 6
                    const contractCard = document.createElement('div');
                    contractCard.className = 'contract-card';
                    contractCard.innerHTML = `
                        <h4>Contract #${contract.id}</h4>
                        <p><strong>Equipment ID:</strong> ${contract['equipment-id']}</p>
                        <p><strong>Service Provider:</strong> ${contract['service-provider'].substring(0, 10)}...</p>
                        <p><strong>Predicted Failure:</strong> Block ${contract['predicted-failure-block']}</p>
                        <p><strong>Contract Value:</strong> ${(contract['contract-value'] / 1000000).toFixed(2)} FIX</p>
                        <p><strong>Status:</strong> <span class="status-active">${contract.status}</span></p>
                    `;
                    contractContainer.appendChild(contractCard);
                });

                if (contractsFound.length === 0) {
                    contractContainer.innerHTML = '<p>No active contracts found.</p>';
                }

            } catch (error) {
                console.error('Error loading contracts:', error);
                document.getElementById('active-contracts').innerHTML = '<p>Error loading contracts.</p>';
            }
        }

        // Check if user is already signed in
        if (userSession.isUserSignedIn()) {
            showWalletInfo();
            loadPlatformStats();
            loadProviderInfo();
        }
    </script>
</body>
</html>
